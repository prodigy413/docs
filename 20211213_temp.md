~~~
#!/bin/bash

GITHUB="prodigy413"
REPO="20211113_github_actions_test"
BRANCH="$1"

## Log function
function message {
    echo $(date "+%Y/%m/%d %H:%M:%S") "$1"
}

## Check commands
commands=("gh" "jq")
for command in ${commands[@]}
do
    sleep 1
    type ${command} > /dev/null 2>&1
    if [ $? -ne 0 ]; then
        message "No ${command} command found."
        exit 1
    fi
done
message "Commands check OK." ; sleep 1

## Check argument
if [ -z $1 ]; then
    message "You need to set argument." 
    exit 1
fi

## Start task
message "Task started"
gh api -X POST "repos/${GITHUB}/${REPO}/actions/workflows/test.yml/dispatches" --input ${BRANCH}.json

sleep 20

while true
do
    STATUS=$(gh api "repos/${GITHUB}/${REPO}/actions/runs" | jq -r .workflow_runs[0].status)
    if [ "${STATUS^^}" = "COMPLETED" ] ; then
        break
    else
        sleep 1
    fi
done

## Process result
RESULT=$(gh api "repos/${GITHUB}/${REPO}/actions/runs" | jq -r .workflow_runs[0].conclusion)
ID=$(gh api "repos/${GITHUB}/${REPO}/actions/runs" | jq -r .workflow_runs[0].id)

if [ "${RESULT^^}" = "SUCCESS" ] ; then
    message "Task completed"
else
    message "Task failed"
    gh -R github.com/${GITHUB}/${REPO} run view ${ID} --log-failed
fi

## Get workflow info
echo -e "\nWorkflow URL"
gh api "repos/${GITHUB}/${REPO}/actions/runs" | jq -r .workflow_runs[0].html_url

gh -R github.com/${GITHUB}/${REPO} run view ${ID} --verbose > $(date "+%Y%m%d")_${REPO}_workflow_info.txt
gh -R github.com/${GITHUB}/${REPO} run view ${ID} --log > $(date "+%Y%m%d")_${REPO}_workflow_log.txt



name: Manually triggered workflow
on:
  workflow_dispatch:
    inputs:
      name:
        description: 'username'
        required: false
        default: 'Obi'

jobs:
  say_hello:
    runs-on: ubuntu-latest
    steps:
      - name: Hello jobs
        run: |
          sleep 20
          echo "Main Branch"
          echo "Hello ${{ github.event.inputs.name }}!"
      - name: Wait jobs
        run: |
          sleep 15
          echo "Wait completed"

~~~
